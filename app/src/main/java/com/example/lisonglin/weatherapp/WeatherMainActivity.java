package com.example.lisonglin.weatherapp;import android.app.Activity;import android.content.Context;import android.content.Intent;import android.content.SharedPreferences;import android.graphics.drawable.PaintDrawable;import android.net.ConnectivityManager;import android.net.NetworkInfo;import android.os.AsyncTask;import android.os.Bundle;import android.os.Handler;import android.os.HandlerThread;import android.os.Message;import android.os.StrictMode;import android.preference.PreferenceManager;import android.util.Log;import android.view.Menu;import android.view.MenuItem;import android.view.View;import android.widget.AdapterView;import android.widget.ArrayAdapter;import android.widget.FrameLayout;import android.widget.ImageView;import android.widget.ListView;import android.widget.RelativeLayout;import android.widget.TextView;import android.widget.Toast;import org.json.JSONException;import org.json.JSONObject;import java.lang.reflect.Array;import java.util.ArrayList;import java.util.List;import static java.lang.System.out;public class WeatherMainActivity extends Activity {    //private static final String Url_getWeatherInfo = "http://www.weather.com.cn/data/sk/101020100.html";    private static final String Url_getWeatherInfo = "http://m.weather.com.cn/data/101020100.html";    public static final String STORE_WEATHER = "store_weather_data";    private RelativeLayout ActivityMainBG;    private  FrameLayout ListFrame;//contain different list    private ListView m_three_line_listview;    private ListView m_five_line_listview;    private ListView m_zhishu_listview;    private ListView m_qushi_listview;    private final static int tag_three_line_list=0;    private final static int tag_five_line_list=1;    private final static int tag_zhishu_list=2;    private final static int tag_qushi_list=3;    private Handler m_Handle;    String  m_NetreturnInfor = null;    private String JsonResultinfo ;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_weather_main);//        StrictMode.ThreadPolicy policy=new StrictMode.ThreadPolicy.Builder().permitAll().build();//        StrictMode.setThreadPolicy(policy);        //check net connect        ConnectivityManager cm = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);        NetworkInfo netinfo = cm.getActiveNetworkInfo();        if(netinfo == null){            Toast.makeText(this,"no connection Can't get weather information",Toast.LENGTH_SHORT).show();            return;        }        //start to get weather infor from network  IN NEW Task        //http://m.weather.com.cn/data/101020100.html        //http://www.weather.com.cn/data/sk/101020100.html        UpdateAsyncTask task =new UpdateAsyncTask();        task.execute(Url_getWeatherInfo);        changeActivityMainBGByWeatherInfo();        ListFrame =(FrameLayout)findViewById(R.id.ListFrame);        m_three_line_listview= new ListView(this);        m_three_line_listview.setSelector(new PaintDrawable(0x00000000));        m_three_line_listview.setAdapter(new ArrayAdapter<String>(this,android.R.layout.simple_list_item_1,getDemoListdata()));        m_three_line_listview.setStackFromBottom(true);        ListFrame.addView(m_three_line_listview,tag_three_line_list);    }    public void changeActivityMainBGByWeatherInfo(){        ActivityMainBG =(RelativeLayout)findViewById(R.id.MainBg);        ActivityMainBG.setBackground(this.getResources().getDrawable(R.drawable.weather_sunny));    }    private List<String> getDemoListdata(){        List<String> data= new ArrayList<String>();        data.add("test data 1");        data.add("test data 2");        data.add("test data 3 asdfasdfasdfasdfsdfasdf");        return data;    }    private void DealWithUrlResult(String urlResult){        String info;        try {            // ==========================瑙ｆ瀽JSON寰楀埌澶╂皵===========================            // JSONObject json=new            // JSONObject(info).getJSONObject("weatherinfo");            JSONObject json = new JSONObject(urlResult).getJSONObject("weatherinfo");            TextView tempText = null;            ImageView imageView = null;            int weather_icon = 0;            // 寤虹珛涓€涓紦瀛樺ぉ姘旂殑鏂囦欢            // SharedPreferences.Editor editor =            // getSharedPreferences(STORE_WEATHER, MODE_PRIVATE).edit();            SharedPreferences.Editor editor = getSharedPreferences(                    STORE_WEATHER, MODE_PRIVATE).edit();            editor.putString("all_data", urlResult);            // city            info = json.getString("city");            tempText = (TextView) findViewById(R.id.gps_location_textview);            tempText.setText(info);            editor.putString("city", info);            // public time            info = json.getString("date_y");            editor.putString("date_y", info);            info = info + "(" + json.getString("week") + ")";            tempText = (TextView) findViewById(R.id.publictime);            tempText.setText(info);            info = json.getString("week");            editor.putString("week", info);            // current temperature            info = json.getString("temp1");            String tempString[]=info.split("~");            int locate= tempString[0].indexOf("℃");            String tempString1=tempString[0].substring(0,locate);            int temp1= Integer.parseInt(tempString1);            locate= tempString[1].indexOf("℃");            tempString1=tempString[1].substring(0,locate);            int temp2= Integer.parseInt(tempString1);            if((temp1+temp2)/2<0){                imageView = (ImageView) findViewById(R.id.temp_negative);                imageView.setVisibility(View.VISIBLE);            }            if((temp1+temp2)/2<10){                imageView = (ImageView) findViewById(R.id.tempImage1);                imageView.setVisibility(View.GONE);            }            int[] tempArray ={R.drawable.zero,R.drawable.one,R.drawable.two,R.drawable.three,R.drawable.four,R.drawable.five,R.drawable.six,R.drawable.seven,                    R.drawable.eight,R.drawable.nine};            imageView = (ImageView) findViewById(R.id.tempImage1);            imageView.setImageResource(tempArray[((temp1+temp2)/2)/10]);            imageView = (ImageView) findViewById(R.id.tempImage2);            imageView.setImageResource(tempArray[((temp1+temp2)/2)%10]);            //tempText = (TextView) findViewById(R.id.currentTemp);            //tempText.setText(info);            info = json.getString("weather1");            tempText = (TextView) findViewById(R.id.cloud_textView);            tempText.setText(info);            editor.putString("weather1", info);            // 澶╂皵鍥炬爣            info = json.getString("img_title1");            //imageView = (ImageView) findViewById(R.id.weather_icon01);            //weather_icon = getWeatherBitMapResource(info);            //imageView.setImageResource(weather_icon);            editor.putInt("img_title1", weather_icon);            // 寰楀埌椋庡悜            info = json.getString("wind1");            tempText = (TextView) findViewById(R.id.wind_textView);            tempText.setText(info);            editor.putString("wind1", info);            // 寰楀埌寤鸿            info = json.getString("index_d");            //tempText = (TextView) findViewById(R.id.index_d);            //tempText.setText(info);            editor.putString("index_d", info);            // 寰楀埌鏄庡ぉ鐨勫ぉ姘?            info = json.getString("weather2");            //tempText = (TextView) findViewById(R.id.weather02);            //tempText.setText(info);            editor.putString("weather2", info);            // 鏄庡ぉ鐨勫浘鏍?            info = json.getString("img_title2");            //imageView = (ImageView) findViewById(R.id.weather_icon02);            //weather_icon = getWeatherBitMapResource(info);            //imageView.setImageResource(weather_icon);            editor.putInt("img_title2", weather_icon);            // 鏄庡ぉ鐨勬皵娓?            info = json.getString("temp2");            //tempText = (TextView) findViewById(R.id.temp02);            //tempText.setText(info);            editor.putString("temp2", info);            // 鏄庡ぉ鐨勯鍔?            info = json.getString("wind2");            //tempText = (TextView) findViewById(R.id.wind02);            //tempText.setText(info);            editor.putString("wind2", info);            // 鍚庡ぉ鐨勫ぉ姘?            info = json.getString("weather3");            //tempText = (TextView) findViewById(R.id.weather03);            //tempText.setText(info);            editor.putString("weather3", info);            // 鍚庡ぉ澶╂皵鍥炬爣            info = json.getString("img_title3");            //imageView = (ImageView) findViewById(R.id.weather_icon03);           // weather_icon = getWeatherBitMapResource(info);            //imageView.setImageResource(weather_icon);            editor.putInt("img_title3", weather_icon);            // 鍚庡ぉ鐨勬皵娓?            info = json.getString("temp3");            //tempText = (TextView) findViewById(R.id.temp03);            //tempText.setText(info);            editor.putString("temp3", info);            // 鍚庡ぉ鐨勯鍔?            info = json.getString("wind3");            //tempText = (TextView) findViewById(R.id.wind03);            //tempText.setText(info);            editor.putString("wind3", info);            info = json.getString("index_co");            tempText = (TextView) findViewById(R.id.airCondition);            tempText.setText(info);            editor.putString("index_co", info);            // 璁剧疆涓€涓湁鏁堟棩鏈熶负5灏忔椂            long validTime = System.currentTimeMillis();            validTime = validTime + 5 * 60 * 60 * 1000;            editor.putLong("validTime", validTime);            // 淇濆瓨            editor.commit();        } catch (JSONException e) {            Log.e("simu","didn't get infor from internet");            TextView tempText = null;            //can't get weather info from internet; use history data;            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this.getApplicationContext());            info=prefs.getString("weather1","can' get weather info weather1");            tempText = (TextView) findViewById(R.id.cloud_textView);            tempText.setText(info);            info=prefs.getString("wind1","can' get wind1");            tempText = (TextView) findViewById(R.id.wind_textView);            tempText.setText(info);            info=prefs.getString("index_co","can' get air condition");            tempText = (TextView) findViewById(R.id.airCondition);            tempText.setText(info);            info=prefs.getString("city","can' get info from city");            tempText = (TextView) findViewById(R.id.gps_location_textview);            tempText.setText(info);            // public time            info=prefs.getString("date_y","can' get date_y info from city");            tempText = (TextView) findViewById(R.id.publictime);            tempText.setText(info);        }            /*        {"weatherinfo":{"city":"上海","cityid":"101020100","temp":"23","WD":"东风","WS":"1级","SD":"96%",                "WSE":"1","time":"11:16","isRadar":"1","Radar":"JC_RADAR_AZ9210_JB","njd":"暂无实况","qy":"1000"}}        {"weatherinfo":        {"city":"上海","city_en":"shanghai","date_y":"2014年3月4日","date":"","week":"星期二","fchh":"11","cityid":"101020100",        "temp1":"11℃~6℃","temp2":"10℃~5℃","temp3":"8℃~4℃","temp4":"8℃~6℃","temp5":"8℃~6℃","temp6":"10℃~5℃",        "tempF1":"51.8℉~42.8℉","tempF2":"50℉~41℉","tempF3":"46.4℉~39.2℉","tempF4":"46.4℉~42.8℉","tempF5":"46.4℉~42.8℉","tempF6":"50℉~41℉",        "weather1":"小雨转多云","weather2":"多云转阴","weather3":"小雨","weather4":"小雨","weather5":"小雨转阴","weather6":"多云",        "img1":"7","img2":"1","img3":"1","img4":"2","img5":"7","img6":"99","img7":"7","img8":"99","img9":"7","img10":"2","img11":"1","img12":"99",        "img_single":"7",        "img_title1":"小雨","img_title2":"多云","img_title3":"多云","img_title4":"阴","img_title5":"小雨","img_title6":"小雨","img_title7":"小雨","img_title8":"小雨",        "img_title9":"小雨","img_title10":"阴","img_title11":"多云","img_title12":"多云","img_title_single":"小雨",        "wind1":"东北风3-4级转北风4-5级","wind2":"北风4-5级转东北风3-4级","wind3":"东风4-5级","wind4":"东风转东北风4-5级","wind5":"东北风3-4级","wind6":"东北风转东风3-4级",        "fx1":"东北风","fx2":"北风","fl1":"3-4级转4-5级","fl2":"4-5级转3-4级","fl3":"4-5级","fl4":"4-5级","fl5":"3-4级","fl6":"3-4级",        "index":"较冷","index_d":"建议着厚外套加毛衣等服装。年老体弱者宜着大衣、呢外套加羊毛衫。","index48":"较冷","index48_d":"建议着厚外套加毛衣等服装。年老体弱者宜着大衣、呢外套加羊毛衫。","index_uv":"最弱","index48_uv":"最弱","index_xc":"不宜","index_tr":"适宜","index_co":"较舒适",        "st1":"10","st2":"3","st3":"9","st4":"2","st5":"7","st6":"2","index_cl":"不宜","index_ls":"不宜","index_ag":"易发"}}        */    }    //get weather infor from internet In BackGround    public class UpdateAsyncTask extends AsyncTask<String, Void, String> {        @Override        protected void onPreExecute(){            //fresh button start to rotate        }        @Override        protected String doInBackground(String... params){            String ResultString=null;            String url = params[0];            out.println("simu doInBackground url= "+url);            ResultString= new WebAccessURLConnection().GetWebContent(url);            return  ResultString;        }        @Override        protected void onPostExecute(String result) {            out.println("simu onPostExecute result = "+result);            //fresh button stop rotate            if(result== null) {                Log.e("simu", "onPostExecute result == null");                return;            }            JsonResultinfo = result;            //deal json string            DealWithUrlResult(result);        }    }}